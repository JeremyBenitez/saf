{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/ajustes.css') }}" />
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

<body>

<div class="container mt-2">
    <!-- Encabezado -->
    <div class="text-center border-bottom pb-1 mb-3">
        <h3>Ajustes de Inventario</h3>
    </div>

    <!-- Seccion de Buscar  -->
    <section id="search">
        <div class="container search-block p-3 row mx-auto justify-content-center text-center">
            <div class="col-12 col-md-6 col-lg-3 mt-4 mt-lg-0">
                <label for="tienda" class="label-style text-capitalize form-label">Tiendas</label>
                <div class="input-group date">
                    <!-- <input type="text" class="form-control p-3 " id="vehicle" placeholder="Select Car Group" /> -->
                    <select class="form-select form-control p-3" id="tienda" aria-label="Default select example"
                        style="background-image: none;">
                        <option value="" disabled>Tiendas</option>
                        <option value="VAD10_KAPITANA">Kapitana</option>
                        <option value="VAD10_CATIA">Catia</option>
                        <option value="VAD10_CRUZVERDE">Cruz Verde</option>
                        <option value="VAD10_PROPATRIA">Propatria</option>
                        <option value="VAD10_BARALT">Baralt</option>
                        <option value="VAD10_MATURIN">Maturin</option>
                        <option value="VAD10_CABIMAS">Cabimas</option>
                        <option value="VAD10_GUANARE">Guanare</option>
                        <option value="VAD10_GUACARA">Guacara</option>
                        <option value="VAD10_CABUDARE">Cabudare</option>
                        <option value="VAD10_CAGUA">Cagua</option>
                        <option value="VAD10_VALENCIA">Valencia</option>
                        <option value="VAD10_BABILON">Babilon</option>
                        <option value="VAD10_VALERA">Valera</option>
                        <option value="VAD10_UPATA">Upata</option>
                        <option value="VAD10_CAPITAL01">Cemen</option>
                    </select>
                    <span class="search-icon-position position-absolute p-2">
                        <i class='bx bx-bar-chart-square'></i>
                    </span>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3 mt-4 mt-lg-0">
                <label for="pick-up-date" class="label-style text-capitalize form-label">Fecha Inicio: </label>
                <div class="input-group date" id="">
                    <input type="date" class="form-control p-3" id="startDate" />

                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3 mt-4 mt-lg-0">
                <label for="return-date" class="label-style text-capitalize form-label">Fecha Fin: </label>
                <div class="input-group date" id="">
                    <input type="date" class="form-control p-3" id="endDate" />

                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3 mt-4 mt-lg-0 justify-content-center">
                <label for="return-date" class="label-style text-capitalize form-label">Buscar</label>
                <div class="input-group">
                    <button class="btn btn-primary b" type="button" id="buscar"><i class='bx bx-search'></i></button>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Sección de Tarjetas -->
    <section class="help-featured-section theme-section">
        <div class="container">
            <div class="d-flex align-items-center justify-content-center border-bottom pb-1 mb-3">
                <h5 class="me-3">Resultados: <span id="cantidad">0</span></h5>
                <input type="text" placeholder="Buscar por Motivo" id="escribir" maxlength="15">
            </div>            
            </div>
            <div class="row align-content-stretch" id="card-container"></div>
        </div>
    </section>

    <!-- Modal de Factura -->
    <div class="modal fade" id="facturaModal" tabindex="-1" aria-labelledby="facturaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="facturaModalLabel">Detalles de la Factura</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Fecha:</strong> <span id="fecha"></span></p>
                    <p><strong>Origen:</strong> <span id="origen"></span></p>
                    <p><strong>Documento:</strong> <span id="codigo"></span></p>
                    <hr>
                    <p><strong>Detalles de los Artículos:</strong></p>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-borderless">
                            <thead>
                                <tr>
                                    <th>Artículo</th>
                                    <th>Cantidad</th>
                                    <th>Total USD</th>
                                </tr>
                            </thead>
                            <tbody id="tablaArticulos">
                                <!-- Aquí se insertarán los artículos dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    
let datosOriginales = []; // Variable global para almacenar los datos originales

// Hacer la función global
async function mostrarFactura(documento) {
    const tienda = document.getElementById('tienda').value;
    const fecha_ini = document.getElementById('startDate').value;
    const fecha_fin = document.getElementById('endDate').value;

    if (!tienda || !fecha_ini || !fecha_fin) {
        Swal.fire("Error", "Faltan datos para obtener la factura", "error");
        return;
    }

    try {
        const response = await fetch(`/ajustes/detalles?documento=${encodeURIComponent(documento)}&tienda=${encodeURIComponent(tienda)}&fecha_ini=${encodeURIComponent(fecha_ini)}&fecha_fin=${encodeURIComponent(fecha_fin)}`);
        const detalles = await response.json();

        if (!response.ok || !detalles.length) {
            Swal.fire("Error", "No se encontraron detalles para esta factura", "error");
            return;
        }

        // Tomamos el primer objeto para llenar la información principal
        const factura = detalles[0];

        // Convertir fecha correctamente en UTC
        //const fecha = factura.f_fecha ? new Date(factura.f_fecha).toLocaleDateString() : "N/P";

        const fecha = factura.f_fecha 
            ? (() => {
                const fechas = new Date(factura.f_fecha);
                return `${fechas.getUTCDate().toString().padStart(2, '0')}/${(fechas.getUTCMonth() + 1).toString().padStart(2, '0')}/${fechas.getUTCFullYear()}`;
            })() 
            : "N/P";

        document.getElementById("fecha").textContent = fecha;
        document.getElementById("origen").textContent = factura.NombreTienda || "N/P";
        document.getElementById("codigo").textContent = documento|| "N/P";

        // Limpiar tabla antes de agregar nuevas filas
        const tabla = document.getElementById("tablaArticulos");
        tabla.innerHTML = "";

        // Llenar la tabla con los artículos
        detalles.forEach(detalle => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td>${detalle.c_CODARTICULO || "N/A"}</td>
                <td>${detalle.n_CANTIDAD || "0"}</td>
                <td>${(detalle.TotalUSD || 0).toFixed(2)}</td>
            `;
            tabla.appendChild(fila);
        });

        // Mostrar modal
        new bootstrap.Modal(document.getElementById("facturaModal")).show();

    } catch (error) {
        console.error("Error al obtener datos de la API:", error);
        Swal.fire("Error", "Hubo un problema al obtener los detalles", "error");
    }
}

// Agregar el evento al cargar el DOM
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("buscar")?.addEventListener("click", async () => {
        const tienda = document.getElementById('tienda').value;
        const fecha_ini = document.getElementById('startDate').value;
        const fecha_fin = document.getElementById('endDate').value;

        if (!tienda || !fecha_ini || !fecha_fin) {
            Swal.fire("Error", "Faltan datos para la búsqueda", "error");
            return;
        }

        try {
            const response = await fetch(`/ajustes/aju?tienda=${encodeURIComponent(tienda)}&fecha_ini=${encodeURIComponent(fecha_ini)}&fecha_fin=${encodeURIComponent(fecha_fin)}`);
            const data = await response.json();

            if (response.ok) {
                // En la función de búsqueda, guarda los datos originales antes de generar tarjetas
                datosOriginales = data; // Guarda los datos completos
                generarTarjetas(data);
            } else {
                Swal.fire("Error", "No hay Datos para esta fecha Seleccionada", "error");
            }
        } catch (error) {
            console.error("Error en la llamada a la API:", error);
            Swal.fire("Error", "Hubo un problema con la solicitud", "error");
        }
    });

    // Función para generar tarjetas dinámicamente
    function generarTarjetas(datos) {
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";
        document.getElementById("cantidad").textContent = datos.length;

        datos.forEach(dato => {
            const card = document.createElement("div");
            // Convertir fecha correctamente en UTC
            //const fecha1 = dato.d_FECHA ? new Date(dato.d_FECHA).toLocaleDateString() : "N/P";

            const fecha1 = dato.d_FECHA 
                ? (() => {
                    const fecha = new Date(dato.d_FECHA);
                    return `${fecha.getUTCDate().toString().padStart(2, '0')}/${(fecha.getUTCMonth() + 1).toString().padStart(2, '0')}/${fecha.getUTCFullYear()}`;
                })() 
                : "N/P";

            card.classList.add("item", "col-12", "col-md-6", "col-lg-3", "py-4", "p-md-4");
            card.innerHTML = `
                <div class="item-inner shadow rounded-4 p-4">
                    <a class="item-link" onclick="mostrarFactura('${dato.c_DOCUMENTO}')">
                        <h4 class="item-heading">Motivo: ${dato.C_MOTIVO}</h4>
                        <h4 class="item-heading">Documento: ${dato.c_DOCUMENTO}</h4>
                    </a>
                    <div class="item-desc text-center">
                        <span class="rate-icon me-2"><i class='bx bx-store'></i></span>${fecha1}
                    </div>
                </div>
            `;
            cardContainer.appendChild(card);
        });
    }

    document.getElementById("escribir").addEventListener("input", function () {
        const filtro = this.value.toLowerCase(); // Obtener el valor en minúsculas
        const datosFiltrados = datosOriginales.filter(dato => 
            dato.C_MOTIVO.toLowerCase().includes(filtro) // Filtrar por motivo
        );
        generarTarjetas(datosFiltrados); // Volver a generar las tarjetas con los datos filtrados
    });
});

</script>

</body>
</html>

{% endblock %}



